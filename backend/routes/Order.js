const router = require("express").Router();
let Order = require("../models/Order");
const { body, param } = require("express-validator");
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');

router.use(helmet());

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
  message: 'Too many requests from this IP, please try again later.',
});

router.use(apiLimiter);


router.route("/addorder").post([
  body('OrderNo').trim().escape(),
  body('ProductName').trim().escape(),
  body('Address').trim().escape(),
  body('Email').trim().escape(),
  body('Price').trim().escape(),
  body('Status').trim().escape(),
], (req, res) => {

    const OrderNo = req.body.OrderNo;
    const ProductName = req.body.ProductName;
    const Address = req.body.Address;
    const Email = req.body.Email;
    const Price = Number(req.body.Price);
    const Status = req.body.Status;

    if (!OrderNo) {
        return res.status(400).json({ message: 'OrderNo is required' });
      }
      if (!ProductName) {
        return res.status(400).json({ message: 'ProductName is required' });
      }
      if (!Address) {
        return res.status(400).json({ message: 'Address is required' });
      }
      if (!Email) {
        return res.status(400).json({ message: 'Email is required' });
      }
      if (!Price) {
        return res.status(400).json({ message: 'Price is required' });
      }
      if (isNaN(Number(Price))) {
        return res.status(400).json({ message: 'Price must be a number' });
      }
      if (!Status) {
        return res.status(400).json({ message: 'Status is required' });
      }
    

    const newOrder = new Order({
        OrderNo,
        ProductName,
        Address,
        Email,
        Price,
        Status
    })

    newOrder.save().then(() => {

        res.json("Order Added")
    }).catch((err) => {
        console.log(err);
    })
})

//Display Orders
router.route("/order").get((req,res) => {
    Order.find().then((order) => {
        
        res.json(order)

    }).catch((err) => {
        console.log(err)
    })
})

//Update Order
router.route("/updateorder/:id").put([
    param('id').trim().escape(),
    body('Status').trim().escape()
  ], async(req,res) => {

    let orderId = req.params.id;

    const {OrderNo, ProductName, Address,Email,Price,Status} = req.body;

    if (!orderId) {
        return res.status(400).json({ message: 'Order ID is required' });
      }
      if (OrderNo && typeof OrderNo !== 'string') {
        return res.status(400).json({ message: 'OrderNo must be a string' });
      }
      if (ProductName && typeof ProductName !== 'string') {
        return res.status(400).json({ message: 'ProductName must be a string' });
      }
      if (Address && typeof Address !== 'string') {
        return res.status(400).json({ message: 'Address must be a string' });
      }
      if (Email && !/^\S+@\S+\.\S+$/.test(Email)) {
        return res.status(400).json({ message: 'Invalid email format' });
      }
      if (Price && isNaN(Number(Price))) {
        return res.status(400).json({ message: 'Price must be a number' });
      }
      if (Status && typeof Status !== 'string') {
        return res.status(400).json({ message: 'Status must be a string' });
      }
        const updateorder = {
            OrderNo,
            ProductName,
            Address,
            Email,
            Price,
            Status
        }

        const update = await Order.findByIdAndUpdate(orderId,updateorder);

        res.status(200).send({status : "Order updated", order : update})

})

router.route("/deleteorder/:id").delete([
  param('id').trim().escape(),
], async(req,res) => {

    let orderId = req.params.id;

    await Order.findByIdAndDelete(orderId).then(() => {
        
        res.status(200).send({status : "Order deleted"});

    }).catch((err) =>{

        console.log(err.message);

        res.status(500).send({status : "Error with delete Order", error : err.message});
    })
    
})





//UPDATING THE STATUS OF A SPECIFIC ORDER.

router.route("/updateOrder/:id").put([
    param('id').trim().escape(),
    body('Status').trim().escape()
  ], async(req,res) => {

    let orderId = req.params.id;

    const Status = req.body.Quantity;
    if (!orderId) {
        return res.status(400).json({ message: 'Order ID is required' });
      }
      if (!Status) {
        return res.status(400).json({ message: 'Status is required' });
      }

        const updateNewStatus = {
            Status
        }

        const update = await Order.findByIdAndUpdate(orderId,updateNewStatus);

        res.status(200).send({status : " Status updated"})
    })

    //get one user
router.route("/getorder/:id").get([
  param('id').trim().escape(),
], async (req, res) => {
    let orderId = req.params.id;

    const order = await Order.findById(orderId).then((orders) => {
        res.status(200).send({ status: "Order fetched", orders })
    }).catch((err) => {
        console.log(err.message);
        res.status(500).send({ status: "Error with geting order", error: err.message })
    })
})

router.get("/search/:key", async (req, res) => {
    let result = await Order.find({
      $or: [
        {
          OrderNo: { $regex: req.params.key },
        },
        {
          ProductName: { $regex: req.params.key },
        },
        
      ],
    });
    res.send(result);
  });
    

module.exports = router;