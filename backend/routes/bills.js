const router = require("express").Router();
const billsSchema = require("../models/bills");
const { body, param } = require("express-validator");
const { isISO8601 } = require('validator');
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');

router.use(helmet());

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, 
  max: 100,
  message: 'Too many requests from this IP, please try again later.',
});

router.use(apiLimiter);


//REad Bills------------------------------------------------------------------

router.get("/readB", async (req, res) => {
    try {
        const data = await billsSchema.find({});
        res.send(data);
      } catch (error) {
        console.error(error);
      }
  })

//Delete Bills----------------------------------------------------------------------------

router.delete("/deleteBills/:id", async (req, res) => {
    const id = req.params.id;
  
    try {
      const result = await billsSchema.findByIdAndRemove(id).exec();
      if (!result) {
        return res.status(404).json({ error: "Bill not found" });
      }
      res.json({ message: "Bill deleted successfully" });
    } catch (error) {
      console.error(error);
      res.status(500).json({ error: "Internal server error" });
    }
  });
  
  //Update Bills----------------------------------------------------------------------------
  
  router.route("/updateBills/:id").put([body("newName").trim().escape(),
    body("newAmount").trim(),
    body("newStatus").trim().escape(),
    body("newDate").trim()], async (req, res) => {
    const id = req.params.id;
  
    const {
      newName,
      newAmount,
      newStatus,
      newDate,
      
    } = req.body;
  
    if (newName === null || newName.trim().length === 0) {
      return res.status(400).json({ error: "Name cannot be null or empty" });
    }
  
    if (newName.length < 3) {
      return res.status(400).json({ error: "Name must be at least 3 characters long" });
    }
  
    if (isNaN(newAmount)) {
      return res.status(400).json({ error: "Amount must be a number" });
    }
  
    if (newStatus === null || newStatus.trim().length === 0) {
      return res.status(400).json({ error: "Status cannot be null or empty" });
    }
  
    if (!isISO8601(newDate)) {
      return res.status(400).json({ error: "Date must be in a valid ISO8601 format" });
    }

    const updateTransaction = {
      name: newName,
      amount: newAmount,
      status: newStatus,
      date: newDate,
     
    };
  
    try {
      const update = await billsSchema
        .findByIdAndUpdate({ _id: id }, updateTransaction)
        .exec();
      if (!update) {
        res.status(404).send("Transaction not found");
        return;
      }
      res.send("Transaction updated successfully");
    } catch (err) {
      console.log(err);
      res.status(500).send("Internal server error");
    }
  });
  
  //Find Bills By ID----------------------------------------------------------------------------
  
  router.get("/readBillsByID/:id",[
    param('id').trim().escape(),
  ], async (req, res) => {
    fetchid = req.params.id;
  
    try {
      var data = await billsSchema.find({ _id: fetchid });
      if (!data) {
        return res.status(404).json({ error: "Bill not found" });
      }
      res.json(data);
    } catch (error) {
      console.error(error);
    }
  });
  
  //Add Bills ----------------------------------------------------------------------------
  
  router.route("/insertBills").post([
    body("name").trim().escape(),
    body("amount").trim(),
    body("status").trim().escape(),
    body("date").trim().escape()
  ], (req, res) => {
    const { name, amount, status, date} = req.body;
  
    if (name === null || name.trim().length === 0) {
      return res.status(400).json({ error: "Name cannot be null or empty" });
    }
  
    if (name.length < 3) {
      return res.status(400).json({ error: "Name must be at least 3 characters long" });
    }
  
    if (isNaN(amount)) {
      return res.status(400).json({ error: "Amount must be a number" });
    }
  
    if (status === null || status.trim().length === 0) {
      return res.status(400).json({ error: "Status cannot be null or empty" });
    }
  
    if (!isISO8601(date)) {
      return res.status(400).json({ error: "Date must be in a valid ISO8601 format" });
    }
    
    var bills = new billsSchema({
      name,
      amount,
      status,
      date,
    });
  
    bills
      .save()
      .then(() => {
        res.json("Supplier Added");
      })
      .catch((err) => {
        console.log(err);
      });
  });
  
  
  
  
  //find Duplicate Bills ----------------------------------------------------------------------------
  
  router.get("/readDuplicate/:did", async (req, res) => {
     
    fetchid=req.params.did;
    try {
        var data = await billsSchema.find({did:fetchid});
        res.send(data);
      } catch (error) {
        console.error(error);
      }
   
  });
  
  
  //Search Bills ----------------------------------------------------------------------------
  
  router.get("/search/:key", async (req, res) => {
    let result = await billsSchema.find({
      $or: [
        {
          name: { $regex: req.params.key },
        },
        {
          status: { $regex: req.params.key },
        },
       
        
      ],
    });
    res.send(result);
  });
  



  module.exports = router;