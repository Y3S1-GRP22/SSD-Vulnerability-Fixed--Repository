const express = require("express");
const mongoose = require("mongoose");
const bodyParser = require("body-parser");
const cors = require("cors");
const dotenv = require("dotenv");
const cookieParser = require("cookie-parser"); // Import cookie-parser
const csrf = require("csurf");

const app = express();
dotenv.config();
const PORT = process.env.PORT || "8070";

// Use cors middleware
app.use(
  cors({
    origin: ["http://localhost:3000", "http://localhost:3006"], // Add your frontend's origin
    credentials: true, // Allow credentials (cookies)
  })
);

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.json({ limit: "50mb", extended: true }));
app.use(express.urlencoded({ limit: "50mb", extended: true }));
app.use(cookieParser()); // Use cookie-parser

// CSRF Protection Middleware
const csrfProtection = csrf({
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production", // Use HTTPS in production
    sameSite: "Strict",
  },
});

app.use("/uploads", express.static("uploads"));

const URL = process.env.MONGODB_URL;

// mongoose.connect(URL);
// mongoose.set("strictQuery", true);

// const connection = mongoose.connection;
// connection.once("open", function () {
//   console.log("Mongodb Connection Success!");
// });

try {
  mongoose.connect(URL);
  mongoose.set("strictQuery", true);

  const connection = mongoose.connection;
  connection.once("open", function () {
    console.log("Mongodb Connection Success!");
  });
} catch (error) {
  console.error("Mongodb Connection Failed:", error.message);
}

app.listen(PORT, () => {
  console.log("Server is up and running on port no " + PORT);
});
app.get("/csrf-token", csrfProtection, (req, res) => {
  res.json({ csrfToken: req.csrfToken() });
});

const salesexecutiveRouter = require("./routes/SalesExecutives.js");
app.use("/salesexecutive", salesexecutiveRouter);

const deliverydriverRouter = require("./routes/DeliveryDrivers.js");
app.use("/deliverydriver", deliverydriverRouter);

const adminRouter = require("./routes/Admins.js");
app.use("/admin", adminRouter);

const loginRouter = require("./routes/Logins.js");
app.use("/login", loginRouter);

const leaveRouter = require("./routes/LeaveApplications.js");
app.use("/leave", leaveRouter);

const salaryRouter = require("./routes/Salaries.js");
app.use("/salary", salaryRouter);

const transactionRouter = require("./routes/Transactions.js");
app.use("/t", transactionRouter);

const supplierRouter = require("./routes/Supplier.js");
app.use("/supplier", supplierRouter);

const supplierTransactionRouter = require("./routes/SupplierTransaction.js");
app.use("/supplierTransaction", supplierTransactionRouter);

const userRouter = require("./routes/users.js");
app.use("/user", userRouter);

const productRoute = require("./routes/product");
app.use("/product", productRoute);

const deliveryRouter = require("./routes/delivery.js");
app.use("/delivery", deliveryRouter);

const orderRouter = require("./routes/Order.js");
app.use("/order", orderRouter);

const couponRouter = require("./routes/Coupon.js");
app.use("/coupon", couponRouter);

const financeTransaction = require("./routes/financeTransaction.js");
app.use("/financeTransaction", financeTransaction);

const bills = require("./routes/bills.js");
const csurf = require("csurf");
app.use("/bills", bills);
