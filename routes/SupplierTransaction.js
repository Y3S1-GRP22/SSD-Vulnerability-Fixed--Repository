const router = require("express").Router();
let SupplierTransaction = require("../models/SupplierTransaction");
const { body, param } = require("express-validator");
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');

router.use(helmet());

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
  message: 'Too many requests from this IP, please try again later.',
});

router.use(apiLimiter);


router.route("/addsupplierTransaction").post([
    body('InvoiceNo').trim().escape(),
    body('SuppliedDate').trim().escape(),
    body('Supplier').trim().escape(),
    body('ProductName').trim().escape(),
    body('Quantity').trim().escape(),
    body('Amount').trim().escape()
], (req, res) => {

    const InvoiceNo = req.body.InvoiceNo;
    const SuppliedDate = req.body.SuppliedDate;
    const Supplier = req.body.Supplier;
    const ProductName = req.body.ProductName;
    const Quantity = Number(req.body.Quantity);
    const Amount = Number(req.body.Amount);

    if (!InvoiceNo) {
        return res.status(400).json({ message: 'InvoiceNo is required' });
    }
    if (!SuppliedDate) {
        return res.status(400).json({ message: 'SuppliedDate is required' });
    }
    if (!Supplier) {
        return res.status(400).json({ message: 'Supplier is required' });
    }
    if (!ProductName) {
        return res.status(400).json({ message: 'ProductName is required' });
    }
    if (!Quantity || isNaN(Quantity) || Quantity <= 0) {
        return res.status(400).json({ message: 'Quantity must be a positive number' });
    }
    if (!Amount || isNaN(Amount) || Amount <= 0) {
        return res.status(400).json({ message: 'Amount must be a positive number' });
    }


    const newSupplierTransaction = new SupplierTransaction({
        InvoiceNo,
        SuppliedDate,
        Supplier,
        ProductName,
        Quantity,
        Amount
    })

    newSupplierTransaction.save().then(() => {

        res.json("Supplier Transaction Added")
    }).catch((err) => {
        console.log(err);
    })
})

//Display Supplier Transaction
router.route("/supplierTransaction").get((req,res) => {
    SupplierTransaction.find().then((supplierTransactions) => {
        
        res.json(supplierTransactions)

    }).catch((err) => {
        console.log(err)
    })
})

//Update Supplier Transactions
router.route("/updatesupplierTransaction/:id").put([
    param('id').trim().escape(),
    body('InvoiceNo').trim().escape(),
    body('SuppliedDate').trim().escape(),
    body('Supplier').trim().escape(),
    body('ProductName').trim().escape(),
    body('Quantity').trim().escape(),
    body('Amount').trim().escape()
], async(req,res) => {

    let supplierTransactionId = req.params.id;

    const {InvoiceNo, SuppliedDate, Supplier,ProductName,Quantity,Amount} = req.body;

    if (!InvoiceNo) {
        return res.status(400).json({ message: 'InvoiceNo is required' });
    }
    if (!SuppliedDate) {
        return res.status(400).json({ message: 'SuppliedDate is required' });
    }
    if (!Supplier) {
        return res.status(400).json({ message: 'Supplier is required' });
    }
    if (!ProductName) {
        return res.status(400).json({ message: 'ProductName is required' });
    }
    if (!Quantity || isNaN(Quantity) || Quantity <= 0) {
        return res.status(400).json({ message: 'Quantity must be a positive number' });
    }
    if (!Amount || isNaN(Amount) || Amount <= 0) {
        return res.status(400).json({ message: 'Amount must be a positive number' });
    }


        const updatesupplierTransaction = {
            InvoiceNo,
            SuppliedDate,
            Supplier,
            ProductName,
            Quantity,
            Amount
        }

        const update = await SupplierTransaction.findByIdAndUpdate(supplierTransactionId,updatesupplierTransaction);

        res.status(200).send({status : "Supplier Transaction updated", supplierTransaction : update})

})

router.route("/deletesupplierTransaction/:id").delete([
    param('id').trim().escape(),
  ], async(req,res) => {

    let supplierTransactionId = req.params.id;

    await SupplierTransaction.findByIdAndDelete(supplierTransactionId).then(() => {
        
        res.status(200).send({status : "supplier Transaction deleted"});

    }).catch((err) =>{

        console.log(err.message);

        res.status(500).send({status : "Error with delete supplier Transaction", error : err.message});
    })
    
})

//get details of single transaction by invoice no
router.route("/getsupplierTransaction/:InvoiceNo").get((req,res)=>{
    let InvoiceNoS = req.params.InvoiceNo;

    SupplierTransaction.find({"InvoiceNo" : InvoiceNoS})
    .then((SupplierTransaction)=>{
        res.status(200).send({status:"Supplier Transaction fetched",SupplierTransaction})
    }).catch((err)=>{
        console.log(err);
        res.status(500).send({status:"Error with Supplier", error : err.message});
    })
})


//Fetching inventory details based on the item code.
router.route("/getsupplierTransactionProductName/:productName").get(async(req,res) => {
    let productName = req.params.productName;

    await SupplierTransaction.findOne({"ProductName" : `${productName}`}).then((supplierTransaction) => {
        res.status(200).send({status : "Supplier Transaction Details fetched", supplierTransaction})
    }).catch((err) => {
        console.log(err.message);

        res.status(500).send({status : "Error with fetching supplier Transaction details",error : err.message});
    })
})

//UPDATING THE QUANTITY OF A SPECIFIC ITEM CODE.

router.route("/updateQuantitysupplierTransaction/:id").put([
    param('id').trim().escape(),
  ], async(req,res) => {

    let supplierTransactionId = req.params.id;

    const Quantity = Number(req.body.Quantity);

        const updateNewQuantity = {
            Quantity
        }

        const update = await SupplierTransaction.findByIdAndUpdate(supplierTransactionId,updateNewQuantity);

        res.status(200).send({status : " new Quantity updated"})
    })


    router.get("/search/:key", async (req, res) => {
        let result = await SupplierTransaction.find({
          $or: [
            {
              InvoiceNo: { $regex: req.params.key },
            },
            {
              ProductName: { $regex: req.params.key },
            },
            {
              Supplier: { $regex: req.params.key },
            },
          ],
        });
        res.send(result);
      });

    router.get('/inventoryReport', async (req, res) => {
        try {
          const products = await SupplierTransaction.aggregate([
            { $group: { _id: '$ProductName', Quantity: { $sum: '$Quantity' } } },
            { $sort: { _id: 1 } },
          ]);
          res.json(products);
        } catch (err) {
          res.json({ message: err });
        }
      });

module.exports = router;